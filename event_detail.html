{% extends 'base.html' %}
{% load static %}

{% block content %}

{# --- Cover banner (fallback to a static default image) --- #}
<div class="event-banner mb-4 text-light"
     style="background:url('{% if event.image %}{{ event.image.url }}{% else %}{% static 'images/default_event.jpg' %}{% endif %}')
            center/cover no-repeat; min-height:220px; border-radius:16px;">
  <div class="p-4" style="position:relative; z-index:1;">
    <h1 class="display-6 m-0">{{ event.title }}</h1>
  </div>
</div>

{# --- Gallery carousel (up to 5 photos) --- #}
{% if event.images.all %}
  <div id="eventCarousel" class="carousel slide mb-4">
    <div class="carousel-inner">
      {% for img in event.images.all %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}">
          <img src="{{ img.image.url }}" class="d-block w-100"
               style="max-height:420px; object-fit:cover;"
               alt="Photo {{ forloop.counter }} of {{ event.title }}">
        </div>
      {% endfor %}
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#eventCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#eventCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>
{% endif %}

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card p-3">
      <h5>About this event</h5>
      <p class="mb-0">{{ event.description|linebreaksbr }}</p>
    </div>

    {% if request.user == event.created_by %}
      <div class="mt-3 d-flex gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'update_event' event.id %}">
          <i class="bi bi-pencil"></i> Edit
        </a>
        <a class="btn btn-outline-danger" href="{% url 'delete_event' event.id %}">
          <i class="bi bi-trash"></i> Delete
        </a>
      </div>
    {% endif %}
  </div>

  <div class="col-lg-4">
    <div class="card p-3 mb-3">
      <h6 class="mb-2">Details</h6>
      <div class="small text-muted"><i class="bi bi-calendar-event"></i> {{ event.date }} {{ event.time }}</div>
      <div class="small text-muted"><i class="bi bi-geo-alt"></i> {{ event.location }}</div>
      <div class="small text-muted"><i class="bi bi-person-badge"></i> Host: {{ event.created_by.username }}</div>
      {% if event.is_private %}
        <div class="small mt-2"><span class="badge bg-warning text-dark">Private</span></div>
      {% endif %}
    </div>

    <div class="card p-3 mb-3">
      <h6 class="mb-2">Attendance</h6>
      {% if request.user.is_authenticated %}
        <form action="{% url 'toggle_rsvp' event.id %}" method="post" class="mb-2">
          {% csrf_token %}
          <button class="btn btn-brand w-100">
            <i class="bi bi-check2-circle"></i> Toggle RSVP
          </button>
        </form>
      {% else %}
        <a class="btn btn-outline-primary w-100" href="{% url 'login' %}?next={{ request.path }}">
          Login to RSVP
        </a>
      {% endif %}

      <div class="mt-2">
        <small class="text-muted">Attendees ({{ event.rsvps.count }})</small>
        <ul class="mt-1 ps-3">
          {% for r in event.rsvps.all %}
            <li>{{ r.user.username }}</li>
          {% empty %}
            <li>No attendees yet.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

{% endblock %}
